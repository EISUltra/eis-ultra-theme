name: Build & Deploy EIS Ultra Theme
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    needs: bump
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout Repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: ðŸ§® Read Version
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Detected version: $VERSION"

      - name: ðŸ—œï¸ Build Theme ZIP
        run: |
          mkdir -p dist
          cd wp-content/themes
          zip -r ../../../dist/eis-ultra-theme-${{ steps.version.outputs.version }}.zip eis-ultra-theme -x "*.git*" "*.github*" "*.DS_Store*" "node_modules/*" "__MACOSX/*"
          echo "âœ… Theme ZIP created in dist/"

      - name: ðŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: eis-ultra-theme-${{ steps.version.outputs.version }}
          path: dist/eis-ultra-theme-${{ steps.version.outputs.version }}.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ§© Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ§® Read Version
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: eis-ultra-theme-${{ steps.version.outputs.version }}
          path: dist

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: "EIS Ultra Theme v${{ steps.version.outputs.version }}"
          body: |
            ðŸ©º **EIS Ultra Theme**  
            Lightweight Â· Modular Â· Blazing Fast  
            Built automatically on push to main.

            ðŸ”– Version: v${{ steps.version.outputs.version }}
            ðŸ“¦ ZIP included as downloadable release asset.
          files: dist/eis-ultra-theme-${{ steps.version.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
