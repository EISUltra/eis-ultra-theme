name: EIS Ultra Theme CI/CD
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  bump:
    name: ðŸ”¼ Auto Bump Version
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout Repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: ðŸ§® Bump Version
        run: |
          php scripts/bump_version.php patch

      - name: ðŸ”„ Sync All style.css Versions
        run: |
          VERSION=$(cat VERSION)
          STYLE_FILES=(
            "wp-content/themes/eis-ultra-theme/style.css"
            "eis-ultra/style.css"
          )
          for FILE in "${STYLE_FILES[@]}"; do
            if [ -f "$FILE" ]; then
              echo "ðŸ”§ Updating Version in $FILE â†’ $VERSION"
              sed -i "s/^Version: .*/Version: $VERSION/" "$FILE"
            else
              echo "âš ï¸ Skipping missing file: $FILE"
            fi
          done

      - name: ðŸ’¾ Commit & Push Version + style.css
        run: |
          git config user.name "EIS Ultra CI"
          git config user.email "ci@eisultra.dev"
          git add VERSION wp-content/themes/eis-ultra-theme/style.css eis-ultra/style.css || true
          git commit -m "Auto bump version â†’ $VERSION [skip ci]" || echo "No changes to commit"
          git push

  build:
    name: ðŸ—ï¸ Build & Package Theme
    needs: bump
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout Repository
        uses: actions/checkout@v3

      - name: âš™ï¸ Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      - name: ðŸ§® Read Version
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Detected version: $VERSION"

      - name: ðŸ—œï¸ Build Theme ZIP
        run: |
          mkdir -p dist
          cd wp-content/themes
          zip -r ../../../dist/eis-ultra-theme-${{ steps.version.outputs.version }}.zip eis-ultra-theme \
            -x "*.git*" "*.github*" "*.DS_Store*" "node_modules/*" "__MACOSX/*"
          echo "âœ… Theme ZIP created: dist/eis-ultra-theme-${{ steps.version.outputs.version }}.zip"

      - name: ðŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: eis-ultra-theme-${{ steps.version.outputs.version }}
          path: dist/eis-ultra-theme-${{ steps.version.outputs.version }}.zip

  release:
    name: ðŸš€ Publish GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ§© Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ§® Read Version
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: eis-ultra-theme-${{ steps.version.outputs.version }}
          path: dist

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: "EIS Ultra Theme v${{ steps.version.outputs.version }}"
          body: |
            ðŸ©º **EIS Ultra Theme**
            Lightweight Â· Modular Â· Blazing Fast  
            Built and released automatically on push to main.

            ðŸ”– Version: v${{ steps.version.outputs.version }}
            ðŸ“¦ ZIP included as downloadable release asset.
          files: dist/eis-ultra-theme-${{ steps.version.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
